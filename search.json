[{"title":"CVE-2022-39952-Fortinet-FortiNAC","url":"/2023/03/03/CVE-2022-39952-Fortinet-FortiNAC/","content":"\n# FortiNAC介绍\n\nFortiNAC（Network Access Control）是由Fortinet推出的网络访问控制系统，可帮助企业管理员建立安全的网络环境，以保护企业网络免受外部威胁。FortiNAC的核心功能是网络访问控制（NAC），它可以帮助企业管理员控制哪些用户可以访问网络，以及哪些用户可以访问特定的网络资源。此外，FortiNAC还可以帮助企业管理员确保网络安全，通过检测和阻止可疑的活动，以及阻止潜在的威胁。FortiNAC还可以自动执行安全策略，以确保网络安全。\n\n## 基本原理\n\nFortiNAC keyUpload 脚本中存在任意文件写入漏洞，未经身份\n认证的远程攻击者可利用此漏洞向目标系统写入任意内容，最终可在目标系统上以 Root 权限执行任意命令。\n\n## 漏洞分析\n\nkeyUpload.jsp文件上传之后直接调用了configApplianceXml命令\n![](CVE-2022-39952-Fortinet-FortiNAC/code.png)\n\n来看看configApplianceXml ,可以看到，这里是直接调用了unzip 命令进行解压\n![](CVE-2022-39952-Fortinet-FortiNAC/code2.png)\n\n我们可以将任意文件写到任意位置\n","tags":["漏洞分析"]},{"title":"域渗透-域信任关系（五）","url":"/2022/10/14/域渗透-域信任关系/","content":"\n\n# 域信任\n\n建立域之间的信任关系，是为了一个域的用户能方便地访问其他域的资源，同时也方便了对域网络的管理和维护。这种模式在带来便利的同时，也存在很多可以被恶意攻击者利用的地方。\n\n","tags":["域渗透攻击与防御"]},{"title":"域渗透 - 信息收集（四）","url":"/2022/09/22/域渗透-信息收集/","content":"# 如何定位域控\n\n1. 非域内环境下寻找域控\n   扫描88，389,636 端口\n\n\n2. 域环境下寻找域控\n```shell\n   net time /domain\t向域控服务器进行时间同步\n   ipconfig /all\n```\n![](域渗透-信息收集/ipconfig.jpg)\n\n3. DNS信息收集\n```shell\nDnscmd . /ZonePrint domain.com\n```\n# 基础信息收集\n\n```bash\nnet session\nnet config workstation                      获取当前工作域信息\nnet group /domain  \t\t\t\t\t\t\t获得所有域用户组列表\nnet group \"domain admins\" /domain  \t\t    获得域管理员列表\nnet group \"enterprise admins\" /domain       获得企业管理员列表\nnet localgroup administrators /domain       获取域内置administrators组用户\nnet group \"domain controllers\" /domain      获得域控制器列表\nnet group \"domain computers\" /domain        获得所有域成员计算机列表\nnet user /domain \t\t\t\t\t\t\t获得所有域用户列表\nnet user 用户名 /domain \t\t\t\t        获得指定账户someuser的详细信息\nnet accounts /domain \t\t\t\t\t\t获得域密码策略设置，密码长短，错误锁定等信息\nnltest /domain_trusts \t\t\t\t\t    获取域信任信息\nnet use                                     查看建立的链接\nnet view /domain                            查看内网存在多少个域\nnet view /domain:<域名称>                    查看指定域中的机器列表\nsetspn -T <域名> -Q */*                      查询域内各种资源服务器\n\nwmic useraccount get /all                   获取域内用户详细信息（用户名，描述信息，等等）\nwmic useraccount get Caption,sid            获取域内所有用户SID\nwimc product get name,version               获取本机软件信息\nwimc service list brief                     获取本机服务\nwimc process list brief                     获取进程\nwimc startup get command,caption            查看启动程序\nwimc share get name,path,status             查看共享\n\ndsquery user        查看存在的用户\ndsquery contact     查找目录中的联系人\ndsquery subnet      查找目录中的子网\n\nschtask /query /fo LIST /v                  查询计划任务\nquery user      查询在线用户\n\n```\n\n\n# 定位域管理员机器\n\n```bash\nPsLoggedOn \\\\1.1.1.1 | username   一些功能需要（通过注册表查询）\n\nPVEFindADUser -noping -current    需要管理员权限\n\nnetview.exe 部分需要\n\nnetsess.exe\n```\n使用PsLoggedon与net group命令区别是PsLoggedon提取的是活跃的域管理员session记录，\n\n# 相关工具\n\n* https://github.com/BloodHoundAD/BloodHound\n* https://github.com/PowerShellMafia/PowerSploit/","tags":["域渗透攻击与防御"]},{"title":"域渗透 - Kerberoast认证流程（三）","url":"/2022/09/22/域渗透-Kerberoast认证流程/","content":"# 0x01 Kerberos背景知识及通信过程\nKerberos是一种由MIT（麻省理工大学）提出的一种网络身份验证协议。它旨在通过使用密钥加密技术为客户端/服务器应用程序提供强身份验证。\n由于Kerberos主要是用在域环境下的身份认证协议，所以在说之前先说下域环境的一些概念。首先域的产生是为了解决企业内部的资源管理问题，比如一个公司就可以在网络中建立一个域环境，更方便内部的资源管理。在一个域中有域控、域管理员、普通用户、主机等等各种资源。\n在Kerberos认证中，最主要的问题是如何证明“你是你”的问题，如当一个Client去访问Server服务器上的某服务时，Server如何判断Client是否有权限来访问自己主机上的服务，同时保证在这个过程中的通讯内容即使被拦截或篡改也不影响通讯的安全性，这正是Kerberos解决的问题。在域渗透过程中Kerberos协议的攻防也是很重要的存在。\n\n# 0x02 Kerberos协议框架\n在Kerberos协议中主要是有三个角色的存在：\n1. 访问服务的Client\n2. 提供服务的Server\n3. KDC（Key Distribution Center）密钥分发中心\n   其中KDC服务默认会安装在一个域的域控中,Client和Server为域内的用户或者是服务，如HTTP服务，SQL服务。\n   在Kerberos中Client是否有权限访问Server端的服务由KDC发放的票据来决定。AD 可以理解成一个数据库，存着域的账号密码等\n\n![](域渗透-Kerberoast认证流程/kerberos.1.png)\n\n● Authentication Server： AS的作用就是验证Client端的身份（确定你是身份证上的本人），验证通过就会给一张TGT（Ticket Granting Ticket）票给Client。\n\n● Ticket Granting server: TGS 的作用是通过 AS 发送给 Client 的票（TGT）换取访问 Server 端的票（上车的票 ST）。ST（ServiceTicket）也被称之为 TGS Ticket，为了和 TGS 区分，在这里就用 ST 来说明，所以TGS Ticket和ST的意思是一样的。\n\n# 0x03 Kerberos认证流程\n\n● Authentication Service Exchange：Client 与 AS 的交互\n● Ticket-Granting Service (TGS) Exchange：Client 与 TGS 的交互\n● Client/Server Authentication Exchange：Client 与 Server 的交互\n\n![](域渗透-Kerberoast认证流程/Kerberos.2.png)\n\n1. AS-REQ：Client向KDC(AS)发起一个认证请求，请求的凭据是Client的NTLM Hash加密的时间戳以及身份信息等\n2. AS-REP：AS使用Client NTLM HASH进行解密，若检验正确则返回用KRBTGT HASH加密的TGT票据(再TGS-REQ中发送到TGS并用于换取ST)，TGT里面包含PAC\n3. TGS-REQ：Client获得TGT缓存在本地(不能解密)，可用来向TGS换取访问相应服务的ST票据\n4. TGS-REP：TGS使用KRBTGT HASH解密TGT，若结果正确，返回用提供服务的服务器的Server Hash(机器用户HASH)加密的ST(server ticket)\n5. AP_REQ：Client拿着获得的ST去服务器请求资源\n6. AP_REP：Server使用自己的Hash解密ST，若解密正确，则拿着获取的PAC去访问KDC判断Client是否有权限访问。KDC解密PAC后获取用户sid以及所在组的信息，并根据访问控制表（ACL）判断权限。若符合，Server返回资源给Client\n\n","tags":["域渗透攻击与防御"]},{"title":"域渗透 - 环境搭建（二）","url":"/2022/09/22/域渗透-环境搭建/","content":"\n## 搭建域环境\n\n* DC：Windows server 2016 \n* Client: Windows 7\n* Server: Windows 10\n\n```text\nWinidows server 2016   10.211.55.13 \nWIndows 10             10.211.55.15 \nWindows 7              10.211.55.10\n```\n \n\n## DC：Winidows server 2016\n\n配置IP与DNS服务器 ，将IP与DNS服务器设为 10.211.55.13\n![](域渗透-环境搭建/2016.1.png)\n修改主机名为DC,保存后重启\n![](域渗透-环境搭建/2016.2.png)\n安装域控制器服务和DNS服务,进入服务器管理器\n![](域渗透-环境搭建/2016.3.png)\n添加角色和功能-->下一步-->基于角色或基于功能的安装,下一步-->下一步-->勾选Active Directory域服务和DNS服务器,下一步\n![](域渗透-环境搭建/2016.4.png)\n功能界面默认即可,下一步-->下一步-->下一步-->勾选如果需要,自动重新启动目标服务器,安装\n![](域渗透-环境搭建/2016.5.png)\nActive Directory服务安装完毕后,将该服务器升级为域控制器.\n![](域渗透-环境搭建/2016.6.png)\n将此服务器提升为域控制器,选择添加新林,自定义根域名,下一步\n![](域渗透-环境搭建/2016.7.png)\n默认下一步就好了,重启后便可登录域管理员账户,记得新建两个域账户,有机器加入域时进行认证\n![](域渗透-环境搭建/2016.8.png)\n\n## server：Windows 10\n配置静态IP改变DNS地址为域控地址\n![](域渗透-环境搭建/10.1.png)\n加入域\n![](域渗透-环境搭建/10.2.png)\n\n## client：Windows 7\n使用域账号进行认证\n![](域渗透-环境搭建/7.1.png)\n","tags":["域渗透攻击与防御"]},{"title":"域渗透 - 基本概念（一）","url":"/2022/09/22/域渗透-基本概念/","content":"\n# 工作组\n\n工作组（Work Group）是局域网中的一个概念。它是最常见最简单最普通的资源管理模式，就是将不同的电脑按功能分别列入不同的组中，以方便管理。\n\n\n# 域\n\n什么是域，举个例子，一个羊群里有很多羊，但是只有一只羊是老大，羊群都受到老大的管理，域又可以理解成一个dns服务器，通常把机器名解析成ip","tags":["域渗透攻击与防御"]}]